#!/usr/bin/env python3
from os import unlink, walk, listdir, rmdir
from os.path import isdir, islink, join, realpath
from sys import argv, exit as sys_exit, stderr


def extract_args(args):
    paths = []
    for i in range(len(args)):
        if args[i] in {"-p", "--preserve"}:
            paths += args[i + 1 :]
            return paths, True
        else:
            paths.append(args[i])
    return paths, False


def rm_empty_dirs(path, preserve):
    for root, dirs, _ in walk(path, topdown=False):
        for dir in dirs:
            folder_path = join(root, dir)
            if listdir(folder_path) == []:
                if islink(folder_path):
                    unlink(folder_path)
                else:
                    rmdir(folder_path)

    if not preserve:
        if listdir(path) == []:
            if islink(path):
                rmdir(realpath(path))
                unlink(path)
            else:
                if path != ".":
                    rmdir(path)
                else:
                    return
        else:
            return
    else:
        return


def main():
    if len(argv) < 2:
        sys_exit("No directory is given")
    else:
        paths, preserve = extract_args(argv[1:])
        for path in paths:
            if isdir(path):
                rm_empty_dirs(path, preserve)
            else:
                print(f"Invalid path: {path}", file=stderr)


if __name__ == "__main__":
    main()
